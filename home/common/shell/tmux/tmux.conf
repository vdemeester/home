# ============================================================================
# BÉPO-OPTIMIZED TMUX CONFIGURATION
# ============================================================================
# Documented by Vincent Demeester.
# Note: Using bépo keyboard layout with CTSR navigation (home row ergonomics)

# ============================================================================
# PREFIX KEY
# ============================================================================
# Using default Ctrl-B prefix (compatible with Emacs workflow)
# Note: Ctrl-Space conflicts with Emacs set-mark-command

# Set window title to enable Kitty detection
set-option -g set-titles on
set-option -g set-titles-string "tmux: #S"

# ============================================================================
# GENERAL SETTINGS
# ============================================================================
set -g history-limit 500000

# By default tmux adds a small delay when sending commands.
# Reducing this delay by setting escape-time.
set -sg escape-time 0

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Enable 24-bit color
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# ============================================================================
# BÉPO NAVIGATION - CTSR (matches vim-bepo)
# ============================================================================

# Pane navigation: C(left) T(down) S(up) R(right)
bind c select-pane -L
bind t select-pane -D
bind s select-pane -U
bind r select-pane -R

# Pane resizing: Shift+CTSR
bind C resize-pane -L 5
bind T resize-pane -D 5
bind S resize-pane -U 5
bind R resize-pane -R 5

# ============================================================================
# WINDOW MANAGEMENT
# ============================================================================

# Window navigation: É(prev) P(next) - home row accessible
bind é previous-window
bind p next-window

# Move windows: Shift+É/P
bind É swap-window -t -1\; select-window -t -1
bind P swap-window -t +1\; select-window -t +1

# Create new window: B (prominent on bépo top-left)
bind b new-window -c "#{pane_current_path}"

# Close window: W
bind w confirm-before -p "kill-window #W? (y/n)" kill-window

# ============================================================================
# SPLITS - Using bépo-accessible symbols
# ============================================================================

# Vertical split: - (minus, accessible on bépo)
bind - split-window -v -c "#{pane_current_path}"

# Horizontal split: | (pipe, Shift+- on bépo)
bind | split-window -h -c "#{pane_current_path}"

# Alternative: = for vertical (no shift needed)
bind = split-window -v -c "#{pane_current_path}"

# Keep default splits with current path
bind '"' split-window -v -c '#{pane_current_path}'
bind '%' split-window -h -c '#{pane_current_path}'

# ============================================================================
# OTHER BINDINGS
# ============================================================================

# Zoom pane: Z
bind z resize-pane -Z

# Copy mode: Escape or [
bind Escape copy-mode
bind [ copy-mode

# Paste: ] or v (keep old binding)
bind ] paste-buffer
bind v paste-buffer

# Reload config: <prefix> + R (Shift+r)
bind R source-file ~/.config/tmux/tmux.conf \; display "✓ Config reloaded!"

# Detach: D
bind d detach-client

# Choose session: A (left home row)
bind a choose-session

# Kill pane: X
bind x confirm-before -p "kill-pane #P? (y/n)" kill-pane

# Legacy bindings (keep for compatibility)
bind u list-sessions
bind y kill-pane
bind C-a last-window
bind C-r command-prompt 'rename-window %%'
bind m switch-client -l
bind M command-prompt -p 'switch session:' "run \"tm.sh '%%'\""

# ============================================================================
# COPY MODE (Emacs-style with bépo)
# ============================================================================

setw -g mode-keys emacs

# Bépo navigation in copy mode (Emacs bindings)
# Note: Emacs mode uses M-c, M-t, M-s, M-r for navigation
bind -T copy-mode M-c send-keys -X cursor-left
bind -T copy-mode M-t send-keys -X cursor-down
bind -T copy-mode M-s send-keys -X cursor-up
bind -T copy-mode M-r send-keys -X cursor-right

# Word movement with bépo (M-é for forward, M-É for backward)
bind -T copy-mode M-é send-keys -X next-word
bind -T copy-mode M-É send-keys -X previous-word

# Copy to clipboard (using wl-copy for Wayland)
# In emacs mode, M-w is the standard copy binding
bind -T copy-mode M-w send-keys -X copy-pipe-and-cancel "wl-copy"

# Alternative: Keep standard Emacs bindings available too
# C-Space to set mark (begin selection) - already works in emacs mode
# M-w to copy - configured above
# ============================================================================
# ADVANCED FEATURES
# ============================================================================

# Maximizing/Restoring panes (useful for many workflows)
unbind Up
bind Up new-window -d -n tmp \; swap-pane -s tmp \; select-window -t tmp
unbind Down
bind Down last-window \; swap-pane -s tmp \; kill-window -t tmp

# Recording pane content to a file
bind-key F1 pipe-pane -o "cat >>~/#W.log" \; display "Toggled logging to ~/#W.log"

# Rather than constraining window size to the maximum size of any client
# connected to the *session*, constrain window size to the maximum size of any
# client connected to *that window*. Much more reasonable.
setw -g aggressive-resize on

# ============================================================================
# APPEARANCE AND STATUS BAR
# ============================================================================

# Status bar at top
set -g status-position top
set -g status-style bg=default,fg=white

# Status left: session name
set-option -g status-left '#[fg=blue,bold]#{session_name} '

# Window status format
set-window-option -g window-status-format ' #I:#W '
set-window-option -g window-status-current-format ' #I:#W '
set-window-option -g window-status-current-style fg=green,bold

# Status right: date and time
set-option -g status-right '#[fg=yellow]%Y-%m-%d %H:%M '

# Pane borders
set -g pane-border-style fg=brightblack
set -g pane-active-border-style fg=blue

# ============================================================================
# NOTIFICATIONS AND MONITORING
# ============================================================================

# Set window notifications
setw -g monitor-activity on
set -g visual-activity off
set -g visual-bell on
set -g visual-silence off
set -g bell-action none

# ============================================================================
# VIM INTEGRATION (Optional - disabled for Emacs users)
# ============================================================================
# Note: The vim-tmux-navigator integration is commented out because it
# intercepts Ctrl-C/T/S/R globally, which breaks:
# - Ctrl-C: Terminal interrupt signal (SIGINT)
# - Ctrl-S/R: Terminal flow control and Emacs bindings
#
# Uncomment if you're a Vim user and want seamless vim/tmux navigation:
#
# is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
# bind -n C-c if-shell "$is_vim" 'send-keys C-c' 'select-pane -L'
# bind -n C-t if-shell "$is_vim" 'send-keys C-t' 'select-pane -D'
# bind -n C-s if-shell "$is_vim" 'send-keys C-s' 'select-pane -U'
# bind -n C-r if-shell "$is_vim" 'send-keys C-r' 'select-pane -R'