#!/usr/bin/env python3
"""
arr - Unified CLI for managing *arr services (Sonarr, Radarr, Lidarr).

This tool provides a consistent interface for common operations across
the *arr media management stack.
"""

import sys
from pathlib import Path

import click

# Add the arr package directory to Python path
ARR_DIR = Path(__file__).parent.resolve()
sys.path.insert(0, str(ARR_DIR))


@click.group()
def cli():
    """Unified CLI for managing *arr services (Sonarr, Radarr, Lidarr).

    This tool provides a consistent interface for common operations across
    the *arr media management stack.
    """
    pass


@cli.group()
def sonarr():
    """Manage Sonarr TV series."""
    pass


@cli.group()
def radarr():
    """Manage Radarr movies."""
    pass


@cli.group()
def lidarr():
    """Manage Lidarr music."""
    pass


@cli.group()
def jellyfin():
    """Manage Jellyfin media server."""
    pass


@sonarr.command()
@click.argument("url")
@click.argument("api_key")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def rename(url, api_key, dry_run, no_confirm):
    """Rename series episodes.

    Examples:
        arr sonarr rename http://localhost:8989 your-api-key
        arr sonarr rename http://localhost:8989 your-api-key --dry-run
    """
    from commands import sonarr_rename
    sonarr_rename.run(url, api_key, dry_run, no_confirm)


@radarr.command()
@click.argument("url")
@click.argument("api_key")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def rename(url, api_key, dry_run, no_confirm):
    """Rename movies.

    Examples:
        arr radarr rename http://localhost:7878 your-api-key
        arr radarr rename http://localhost:7878 your-api-key --dry-run
    """
    from commands import radarr_rename
    radarr_rename.run(url, api_key, dry_run, no_confirm)


@lidarr.command("rename-albums")
@click.argument("url")
@click.argument("api_key")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def lidarr_rename_albums(url, api_key, dry_run, no_confirm):
    """Rename albums.

    Examples:
        arr lidarr rename-albums http://localhost:8686 your-api-key
        arr lidarr rename-albums http://localhost:8686 your-api-key --dry-run
    """
    from commands import lidarr_rename_albums
    lidarr_rename_albums.run(url, api_key, dry_run, no_confirm)


@lidarr.command("retag-albums")
@click.argument("url")
@click.argument("api_key")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def lidarr_retag_albums(url, api_key, dry_run, no_confirm):
    """Retag albums metadata.

    Examples:
        arr lidarr retag-albums http://localhost:8686 your-api-key
        arr lidarr retag-albums http://localhost:8686 your-api-key --dry-run
    """
    from commands import lidarr_retag_albums
    lidarr_retag_albums.run(url, api_key, dry_run, no_confirm)


@lidarr.command("update-paths")
@click.argument("url")
@click.argument("api_key")
@click.argument("music_folder")
@click.option("--dry-run", is_flag=True, help="Show what would be updated without making changes")
def lidarr_update_paths(url, api_key, music_folder, dry_run):
    """Update library paths.

    Examples:
        arr lidarr update-paths http://localhost:8686 your-api-key /data/music
        arr lidarr update-paths http://localhost:8686 your-api-key /data/music --dry-run
    """
    from commands import lidarr_update_paths
    lidarr_update_paths.run(url, api_key, music_folder, dry_run)


@lidarr.command("update-monitoring")
@click.argument("url")
@click.argument("api_key")
@click.option("--monitor", default="future", type=click.Choice(["all", "future", "missing", "existing", "none"]), help="Album monitoring mode (default: future)")
@click.option("--monitor-new-items", type=click.Choice(["all", "new", "none"]), help="Monitor new items mode - controls automatic monitoring of albums added to MusicBrainz after the artist is in Lidarr")
@click.option("--artist", "-a", help="Filter by artist name pattern (case-insensitive)")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def lidarr_update_monitoring(url, api_key, monitor, monitor_new_items, artist, dry_run, no_confirm):
    """Update artist monitoring settings.

    Changes the monitoring mode for artists in Lidarr. By default updates
    all artists to monitor 'future' albums only.

    Monitoring modes (--monitor):
      - all: Monitor all albums (past and future)
      - future: Monitor only future albums (default)
      - missing: Monitor only missing albums
      - existing: Monitor only existing albums
      - none: Don't monitor any albums

    Monitor new items modes (--monitor-new-items):
      Controls what happens with albums added to MusicBrainz AFTER the artist
      is already in Lidarr (e.g., new releases or newly discovered old albums)
      - all: Automatically monitor all new albums
      - new: Monitor new albums
      - none: Don't monitor new albums

    Examples:
        # Update all artists to monitor future albums only
        arr lidarr update-monitoring http://localhost:8686 your-api-key

        # Update specific artist pattern
        arr lidarr update-monitoring http://localhost:8686 your-api-key \\
            --artist "Taylor Swift"

        # Set all artists to monitor all albums
        arr lidarr update-monitoring http://localhost:8686 your-api-key \\
            --monitor all

        # Set all artists to monitor future albums and auto-monitor new items
        arr lidarr update-monitoring http://localhost:8686 your-api-key \\
            --monitor future --monitor-new-items all

        # Dry run to see what would change
        arr lidarr update-monitoring http://localhost:8686 your-api-key \\
            --dry-run
    """
    from commands import lidarr_update_monitoring
    lidarr_update_monitoring.run(url, api_key, monitor, monitor_new_items, artist, dry_run, no_confirm)


@lidarr.command("update-metadata-profile")
@click.argument("url")
@click.argument("api_key")
@click.option("--profile", "-p", help="Metadata profile name to apply (if not specified, lists available profiles)")
@click.option("--artist", "-a", help="Filter by artist name pattern (case-insensitive)")
@click.option("--dry-run", is_flag=True, help="Show what would be changed without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def lidarr_update_metadata_profile(url, api_key, profile, artist, dry_run, no_confirm):
    """Update artist metadata profile settings.

    Changes the metadata profile for artists in Lidarr. Metadata profiles
    control which release types and album types are monitored (e.g., studio
    albums, EPs, live albums, etc.).

    If no profile is specified, the command will list available profiles and
    use the first one as default.

    Examples:
        # List available metadata profiles and update all artists to first one
        arr lidarr update-metadata-profile http://localhost:8686 your-api-key

        # Update all artists to a specific metadata profile
        arr lidarr update-metadata-profile http://localhost:8686 your-api-key \\
            --profile "Standard"

        # Update specific artist pattern
        arr lidarr update-metadata-profile http://localhost:8686 your-api-key \\
            --profile "Standard" --artist "Taylor Swift"

        # Dry run to see what would change
        arr lidarr update-metadata-profile http://localhost:8686 your-api-key \\
            --profile "Standard" --dry-run
    """
    from commands import lidarr_update_metadata_profile
    lidarr_update_metadata_profile.run(url, api_key, profile, artist, dry_run, no_confirm)


@lidarr.command("sync-spotify")
@click.argument("url")
@click.option("--api-key", "-k", envvar="LIDARR_API_KEY", required=True, help="Lidarr API key")
@click.option("--spotify-client-id", envvar="SPOTIFY_CLIENT_ID", required=True, help="Spotify application client ID")
@click.option("--spotify-client-secret", envvar="SPOTIFY_CLIENT_SECRET", required=True, help="Spotify application client secret")
@click.option("--spotify-username", "-u", envvar="SPOTIFY_USERNAME", help="Spotify username for interactive mode (to list your playlists)")
@click.argument("playlist_ids", nargs=-1, required=False)
@click.option("--root-folder", default="/music", help="Root folder for music in Lidarr")
@click.option("--monitor", default="all", type=click.Choice(["all", "future", "missing", "existing", "none"]), help="Album monitoring mode")
@click.option("--request-delay", default=1.5, type=float, help="Delay between Lidarr API requests (seconds)")
@click.option("--all-playlists", is_flag=True, help="Select all playlists (skip fzf selection)")
@click.option("--dry-run", is_flag=True, help="Show what would be added without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def lidarr_sync_spotify(url, api_key, spotify_client_id, spotify_client_secret, spotify_username, playlist_ids, root_folder, monitor, request_delay, all_playlists, dry_run, no_confirm):
    """Sync Spotify playlists to Lidarr.

    Fetches tracks from Spotify playlists and adds missing artists to Lidarr.

    URL: Lidarr server URL (e.g., http://localhost:8686)

    Credentials can be provided via flags or environment variables:
    - LIDARR_API_KEY
    - SPOTIFY_CLIENT_ID (get from https://developer.spotify.com/dashboard)
    - SPOTIFY_CLIENT_SECRET
    - SPOTIFY_USERNAME (optional, for interactive mode)

    Interactive mode: If no PLAYLIST_IDS are provided and --spotify-username
    is set, you'll be prompted to select from your public playlists using fzf.

    Examples:
        # Interactive mode - select from your playlists
        export SPOTIFY_USERNAME=your-spotify-username
        arr lidarr sync-spotify http://localhost:8686 -u your-username

        # Or with environment variables
        export LIDARR_API_KEY=your-lidarr-key
        export SPOTIFY_CLIENT_ID=your-client-id
        export SPOTIFY_CLIENT_SECRET=your-client-secret
        export SPOTIFY_USERNAME=your-username
        arr lidarr sync-spotify http://localhost:8686

        # Select all playlists automatically
        arr lidarr sync-spotify http://localhost:8686 -u username --all-playlists

        # Sync specific playlists (no username needed)
        arr lidarr sync-spotify http://localhost:8686 \\
            37i9dQZF1DXcBWIGoYBM5M 37i9dQZF1DX0XUsuxWHRQd

        # Dry run to see artist list for manual addition
        arr lidarr sync-spotify http://localhost:8686 -u username --dry-run

        # Monitor only future albums
        arr lidarr sync-spotify http://localhost:8686 \\
            -u username --monitor future
    """
    from commands import lidarr_sync_spotify
    lidarr_sync_spotify.run(
        url,
        api_key,
        spotify_client_id,
        spotify_client_secret,
        spotify_username,
        list(playlist_ids),
        root_folder,
        monitor,
        request_delay,
        dry_run,
        no_confirm,
        all_playlists
    )


@jellyfin.command("sync-spotify")
@click.option("--url", envvar="JELLYFIN_URL", default="http://localhost:8096", help="Jellyfin server URL")
@click.option("--api-token", "-t", envvar="JELLYFIN_API_TOKEN", required=True, help="Jellyfin API token")
@click.option("--user-id", "-i", envvar="JELLYFIN_USER_ID", required=True, help="Jellyfin user ID")
@click.option("--spotify-client-id", envvar="SPOTIFY_CLIENT_ID", required=True, help="Spotify application client ID")
@click.option("--spotify-client-secret", envvar="SPOTIFY_CLIENT_SECRET", required=True, help="Spotify application client secret")
@click.option("--spotify-username", "-u", envvar="SPOTIFY_USERNAME", help="Spotify username for interactive mode (to list your playlists)")
@click.option("--playlist-id", "-p", "playlist_ids", multiple=True, help="Spotify playlist ID (can be specified multiple times)")
@click.option("--all", "--all-playlists", "all_playlists", is_flag=True, help="Sync all user playlists (requires --spotify-username)")
@click.option("--match-threshold", default=0.6, type=float, help="Minimum confidence score for track matching (0.0-1.0)")
@click.option("--public", is_flag=True, help="Make created playlists public")
@click.option("--dry-run", is_flag=True, help="Show what would be created without making changes")
@click.option("--no-confirm", "--yolo", is_flag=True, help="Skip interactive confirmation (use with caution)")
def jellyfin_sync_spotify(url, api_token, user_id, spotify_client_id, spotify_client_secret, spotify_username, playlist_ids, match_threshold, all_playlists, public, dry_run, no_confirm):
    """Sync Spotify playlists to Jellyfin.

    Fetches tracks from Spotify playlists and creates matching playlists in Jellyfin.

    Three modes of operation:
    1. Interactive selector (fzf): Use --spotify-username without --playlist-id or --all
    2. Sync all playlists: Use --spotify-username --all
    3. Sync specific playlists: Use --playlist-id (one or more times)

    All options can be provided via flags or environment variables:
    - JELLYFIN_URL (default: http://localhost:8096)
    - JELLYFIN_API_TOKEN (get from Jellyfin Dashboard > API Keys)
    - JELLYFIN_USER_ID (get from user profile URL)
    - SPOTIFY_CLIENT_ID (get from https://developer.spotify.com/dashboard)
    - SPOTIFY_CLIENT_SECRET
    - SPOTIFY_USERNAME (optional, for interactive/all modes)

    Examples:
        # Interactive mode - select playlists with fzf
        export JELLYFIN_API_TOKEN=your-token
        export JELLYFIN_USER_ID=your-user-id
        export SPOTIFY_CLIENT_ID=your-client-id
        export SPOTIFY_CLIENT_SECRET=your-client-secret
        export SPOTIFY_USERNAME=your-username
        arr jellyfin sync-spotify

        # Sync ALL playlists from a user
        arr jellyfin sync-spotify -u username --all

        # Sync specific playlists by ID
        arr jellyfin sync-spotify \\
            -p 37i9dQZF1DXcBWIGoYBM5M -p 37i9dQZF1DX0XUsuxWHRQd

        # Dry run with interactive selection
        arr jellyfin sync-spotify -u username --dry-run

        # Lower match threshold for more matches (may have false positives)
        arr jellyfin sync-spotify -u username --match-threshold 0.4

        # Make playlists public
        arr jellyfin sync-spotify -u username --public
    """
    from commands import jellyfin_sync_spotify
    jellyfin_sync_spotify.run(
        url,
        api_token,
        user_id,
        spotify_client_id,
        spotify_client_secret,
        spotify_username,
        list(playlist_ids),
        match_threshold,
        dry_run,
        no_confirm,
        all_playlists,
        public
    )


if __name__ == "__main__":
    cli()
