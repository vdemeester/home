#+TITLE: =home= monorepo
#+FILETAGS: #home infra configuration dotfiles monorepo

A comprehensive monorepo containing personal infrastructure, system
configurations, and tools, primarily built using [[https://nixos.org/nix][Nix]].

* Overview

This repository serves as a centralized location for:
- NixOS system configurations for multiple machines
- Home-manager configurations
- Custom tools and personal configurations
- Infrastructure management

See [[file:CLAUDE.md][CLAUDE.md]] for Claude Code-specific guidance on working with this repository.

* Repository Structure

** =/systems=
Contains NixOS system configurations organized as follows:
- Individual host configurations (aix, aomi, athena, demeter, kyushu, sakhalin, rhea, kerkouane, etc.)
- Common configurations shared across systems:
  + Base system setup
  + Desktop environments (Sway, Niri)
  + Hardware-specific configurations
  + Program configurations
  + Service configurations
  + User management

** =/home=
Home-manager configurations for different users and environments:
- Common configurations for desktop environments
- Development tools and settings:
  + AI tooling configuration (aichat, AI prompts/roles)
  + Go, Python, Nix development environments
  + Emacs configuration
  + Container tooling
- Shell configurations (zsh, tmux, etc.)
- Service configurations (syncthing, etc.)

** =/dots=
Traditional dotfiles managed outside of home-manager:
- Niri window manager configuration
- Makefile-based dotfile installation system
- Additional application-specific configurations

** =/tools=
Custom tools and utilities:
- Battery monitor
- Emacs configuration
- Various Go-based utilities

** =/pkgs=
Custom Nix packages and overlays including:
- Development tools (govanityurl, manifest-tool)
- System utilities (battery-monitor, systemd-email, vrsync)
- Custom scripts and utilities (ape, ram, batzconverter)
- Emacs packages

** =/modules=
NixOS modules providing additional functionality:
- Wireguard client/server configurations
- Go vanity URL service
- Gosmee service

** =/lib=
Core library functions for flake configuration:
- =mkHost= - Generate NixOS configurations
- =mkHome= - Generate home-manager configurations
- =mkSystemManager= - Generate system-manager configurations
- Helper functions for configuration building

** =/overlays=
Nix overlays for:
- Custom package additions
- Package modifications
- Unstable package access

** =/keyboards=
Hardware keyboard configurations with complete build and flash tooling.

See [[file:keyboards/README.org][keyboards/README.org]] for detailed keyboard documentation and usage.

*** Moonlander
Located in =/keyboards/moonlander=:
- QMK-based configuration for the ZSA Moonlander keyboard
- 72-key split ergonomic keyboard with RGB backlighting
- Wired USB-C connectivity
- See [[file:keyboards/moonlander/README.org][keyboards/moonlander/README.org]] for full documentation

*** Eyelash Corne
Located in =/keyboards/eyelash_corne=:
- ZMK-based configuration for the wireless Corne (crkbd) keyboard
- 42-key split ergonomic keyboard with nice!view display
- Wireless Bluetooth connectivity with nice!nano v2
- RGB underglow and custom animations
- See [[file:keyboards/eyelash_corne/README.org][keyboards/eyelash_corne/README.org]] for full documentation

*** Kanata (software)
Located in =systems/kyushu/main.kbd=:
- Software keyboard remapper configuration to mimic mechanical keyboards
- System-level key remapping for non-keyboard hardware

** =/imperative=
Idempotent configuration scripts for systems not managed by NixOS, organized by hostname:
- Each host has its own directory (e.g., =/imperative/nagoya/=)
- Scripts are designed to be run repeatedly to maintain system state
- Primary script in each host directory is typically =apply.sh=
- Used for bootstrapping and ongoing configuration management of non-NixOS systems (Debian, Arch, Windows, etc.)

Examples of hosts that may have imperative configurations:
- =nagoya= - Debian-based system (server)
- =wakasu= - Fedora-based system (desktop)
- Additional systems running operating systems other than NixOS

* Usage

The main entry point is =flake.nix=, which provides:

- NixOS configurations for various hosts
- Home-manager configurations
- System-manager configurations
- Custom packages and overlays

** Building a System

To build and activate a system configuration:

#+begin_src bash
nixos-rebuild switch --flake .#<hostname>
#+end_src

** Installing a New System

For new systems that already have a configuration in this repository,
you can use the =install.sh= script which uses =disko= for disk
partitioning and installation:

#+begin_src bash
./install.sh <hostname> [additional-disko-options]
#+end_src

This will:
1. Use the disko-install tool to partition and format disks
2. Install the system configuration for the specified hostname

** Available Make Targets

The repository includes several useful make targets for common operations:

*** System Management
- =make boot= - Build and boot the current system configuration
- =make switch= - Build and switch to the new system configuration
- =make build= - Build the system configuration without activating
- =make dry-build= - Test build the configuration without making changes

*** Remote Host Management
- =make host/<hostname>/build= - Build configuration for a specific host
- =make host/<hostname>/boot= - Build and boot configuration on a remote host
- =make host/<hostname>/switch= - Build and switch configuration on a remote host

*** Development
- =make fmt= - Format Nix files using nixpkgs-fmt
- =make pre-commit= - Run pre-commit checks

*** Keyboards
- =make keyboards/moonlander/build= - Build Moonlander QMK firmware
- =make keyboards/moonlander/flash= - Build and flash Moonlander firmware
- =make keyboards/moonlander/update= - Update QMK submodules
- =make keyboards/moonlander/clean= - Clean Moonlander build artifacts
- =make keyboards/eyelash_corne/build= - Build Eyelash Corne ZMK firmware
- =make keyboards/eyelash_corne/flash= - Build and flash Eyelash Corne firmware
- =make keyboards/draw= - Generate keymap SVGs for all keyboards
- =make keyboards/moonlander/draw= - Generate keymap SVG for Moonlander
- =make keyboards/eyelash_corne/draw= - Generate keymap SVG for Eyelash Corne

See [[file:keyboards/README.org][keyboards/README.org]] for detailed keyboard documentation.

*** Maintenance
- =make clean= - Clean up old system generations and results
- =make clean-system= - Remove system generations older than 15 days
- =make clean-results= - Remove symlinks to build results
- =nix flake update= - Update flake inputs (nixpkgs, home-manager, etc.)

** Updating Home Configuration

To update home-manager configuration:

#+begin_src bash
home-manager switch --flake .#<username>@<hostname>
#+end_src

** Managing Dotfiles

For configurations not managed by home-manager, the =/dots= directory
provides a Makefile-based installation system:

#+begin_src bash
cd dots
make all  # Install all dotfiles
make niri # Install only niri configuration
#+end_src

** Managing Non-NixOS Systems

For systems not managed by NixOS, the =/imperative= directory provides
idempotent configuration scripts organized by hostname.

See [[file:imperative/README.org][imperative/README.org]] for detailed documentation.

*** Running Configuration Scripts

#+begin_src bash
# Apply configuration for a specific host
sudo ./imperative/<hostname>/apply.sh

# With environment variables (e.g., for wireguard)
sudo WG_PRIVATE_KEY="..." ./imperative/<hostname>/apply.sh
#+end_src

*** Available Hosts

**** nagoya (Debian Server)
#+begin_src bash
# Configure nagoya with wireguard
sudo WG_PRIVATE_KEY="your-key" ./imperative/nagoya/apply.sh
#+end_src

Installs: Docker, Kind, Wireguard, Syncthing

See [[file:imperative/nagoya/README.org][imperative/nagoya/README.org]] for details.

**** wakasu (Fedora Desktop)
#+begin_src bash
# Configure wakasu
sudo ./imperative/wakasu/apply.sh

# With wireguard
sudo WG_PRIVATE_KEY="your-key" ./imperative/wakasu/apply.sh
#+end_src

Installs: Helix, ACPI, Wireguard, Syncthing

See [[file:imperative/wakasu/README.org][imperative/wakasu/README.org]] for details.

** Building and Installing Packages

The repository provides various custom packages that can be built and installed directly from the flake:

*** Building a Single Package
To build a specific package:

#+begin_src bash
nix build .#<package-name>
#+end_src

*** Installing a Package
To install a package in your profile:

#+begin_src bash
nix profile install .#<package-name>
#+end_src

*** Available Packages
All packages are defined in the =/pkgs= directory and are available for both =x86_64-linux= and =aarch64-linux= systems. Notable packages include:

**** Development Tools
- =battery-monitor= - System battery monitoring utility
- =govanityurl= - Go vanity URL service
- =manifest-tool= - Container manifest tool

**** Chmouzies (Helper Scripts)
- =chmouzies-ai= - AI-related helper scripts
- =chmouzies-git= - Git workflow helpers
- =chmouzies-kubernetes= - Kubernetes utilities

**** System Utilities
- =vrsync= - Custom rsync utility
- =vde-thinkpad= - ThinkPad-specific utilities
- =systemd-email= - Email notifications for systemd
- =nixfmt-plus= - Enhanced Nix formatter

**** Custom Scripts
- =scripts= - Collection of utility scripts for various tasks
- =ape= - Custom utility package
- =ram= - Custom utility package
- =batzconverter= - Custom conversion utility

**** Emacs Packages
- =bookmark-plus= - Enhanced bookmarking for Emacs

To list all available packages:

#+begin_src bash
nix flake show
#+end_src

* Development

A development shell is provided with necessary tools:
- Git
- Prettier
- Deadnix
- nixfmt-rfc-style
- agenix

To enter the development environment:

#+begin_src bash
nix develop
#+end_src

Pre-commit hooks are configured for:
- Go formatting (gofmt)
- Nix formatting (nixfmt-rfc-style) and linting (deadnix)
- Python linting (flake8, ruff)
- Shell script checking (shellcheck)

** Continuous Integration

GitHub Actions workflows automatically:
- Build all NixOS system configurations
- Build all custom packages
- Build keyboard firmware (Corne, Moonlander)
- Run automated flake updates via Dependabot

* Supported Systems

- =x86_64-linux=
- =aarch64-linux=

** Current Hosts

*** Desktop Systems (unstable)
- =kyushu= - Work laptop (Niri desktop)
- =foobar= - Test VM (Niri desktop)

*** Servers (unstable)
- =aomi= - Server
- =sakhalin= - Server

*** Servers (stable, NixOS 25.05)
- =athena= - Raspberry Pi 4
- =demeter= - Raspberry Pi 4
- =aix= - Raspberry Pi 4
- =aion= - aarch64 server
- =rhea= - aarch64 server
- =kerkouane= - =x86_64= server

*** Non-NixOS Systems (Imperative Configuration)
- =nagoya= - Debian server (aarch64)
- =wakasu= - Fedora desktop

See [[file:imperative/README.org][imperative/README.org]] for details on managing these systems.

* References

Repositories that inspired or contributed to this configuration:

** Active References
- [[https://github.com/jordanisaacs/dotfiles][https://github.com/jordanisaacs/dotfiles]]
- [[https://github.com/chvp/nixos-config][https://github.com/chvp/nixos-config]]
- [[https://github.com/gytis-ivaskevicius/nixfiles][https://github.com/gytis-ivaskevicius/nixfiles]]
- [[https://github.com/davidtwco/veritas][https://github.com/davidtwco/veritas]]
- [[https://github.com/buckley310/nixos-config][https://github.com/buckley310/nixos-config]]
- [[https://github.com/eadwu/nixos-configuration][https://github.com/eadwu/nixos-configuration]]
- [[https://github.com/berbiche/dotfiles][https://github.com/berbiche/dotfiles]]
- [[https://github.com/hlissner/dotfiles][https://github.com/hlissner/dotfiles]]
- [[https://github.com/Mic92/dotfiles][https://github.com/Mic92/dotfiles]]
- [[https://github.com/lovesegfault/nix-config][https://github.com/lovesegfault/nix-config]]
- [[https://github.com/bqv/nixrc][https://github.com/bqv/nixrc]]
- [[https://github.com/leotaku/nixos-config][https://github.com/leotaku/nixos-config]]
- [[https://github.com/rasendubi/dotfiles][https://github.com/rasendubi/dotfiles]]
- [[https://git.tazj.in/about/][https://git.tazj.in/about/]]
- [[https://github.com/danieldk/nix-home][https://github.com/danieldk/nix-home]]
- [[https://github.com/terlar/nix-config][https://github.com/terlar/nix-config]]
  + [[https://github.com/terlar/emacs-config][https://github.com/terlar/emacs-config]]
- [[https://github.com/foo-dogsquared/nixos-config][https://github.com/foo-dogsquared/nixos-config]]
- [[https://github.com/barrucadu/nixfiles][https://github.com/barrucadu/nixfiles]]
- [[https://github.com/EmergentMind/nix-config][https://github.com/EmergentMind/nix-config]]
- [[https://github.com/shahinism/45r4r][https://github.com/shahinism/45r4r]]
- [[https://github.com/wimpysworld/nix-config][https://github.com/wimpysworld/nix-config]]
- [[https://github.com/Hoverbear-Consulting/flake][https://github.com/Hoverbear-Consulting/flake]]
- [[https://github.com/jnsgruk/nixos-config][https://github.com/jnsgruk/nixos-config]]
- [[https://gitlab.com/ahoneybun/nix-configs][https://gitlab.com/ahoneybun/nix-configs]]
- [[https://github.com/akirak/homelab][https://github.com/akirak/homelab]]
- [[https://git.sr.ht/~akirak/nix-config][https://git.sr.ht/~akirak/nix-config]]
- [[https://github.com/akirak/nix-desktop][https://github.com/akirak/nix-desktop]]
- [[https://git.rossabaker.com/ross/cromulent][https://git.rossabaker.com/ross/cromulent]]
- [[https://github.com/thiagokokada/nix-configs][https://github.com/thiagokokada/nix-configs]]
- [[https://github.com/JRMurr/NixOsConfig][https://github.com/JRMurr/NixOsConfig]]
- [[https://github.com/dzervas/dotfiles][https://github.com/dzervas/dotfiles]]
- https://github.com/mirdaki/computer-config
- https://github.com/Suya1671/commafiles
- https://github.com/caelestia-dots/shell

** Historical References
- [[https://gitlab.com/samueldr/nixos-configuration][https://gitlab.com/samueldr/nixos-configuration]]
- [[https://github.com/yurrriq/dotfiles][https://github.com/yurrriq/dotfiles]]
- [[https://github.com/akirak/nixos-config][https://github.com/akirak/nixos-config]]
- [[https://github.com/akirak/home.nix][https://github.com/akirak/home.nix]]
- [[https://github.com/cstrahan/nixos-config][https://github.com/cstrahan/nixos-config]]
- [[https://github.com/jwiegley/nix-config][https://github.com/jwiegley/nix-config]]
- [[https://github.com/arianvp/nixos-stuff][https://github.com/arianvp/nixos-stuff]]
- [[https://github.com/romatthe/ronix][https://github.com/romatthe/ronix]]
- [[https://github.com/rummik/nixos-config][https://github.com/rummik/nixos-config]]
- [[https://github.com/a-schaefers/nix-config.old][https://github.com/a-schaefers/nix-config.old]]
- [[https://github.com/auntieNeo/nixrc][https://github.com/auntieNeo/nixrc]]
- [[https://github.com/glines/nixrc][https://github.com/glines/nixrc]]
- [[https://github.com/therealpxc/pxc.nix.d][https://github.com/therealpxc/pxc.nix.d]]
- [[https://github.com/tycho01/nix-config][https://github.com/tycho01/nix-config]]
- [[https://github.com/ghuntley/dotfiles-nixos][https://github.com/ghuntley/dotfiles-nixos]]
- [[https://github.com/budevg/nix-conf][https://github.com/budevg/nix-conf]]
- [[https://github.com/cleverca22/nixos-configs][https://github.com/cleverca22/nixos-configs]]
- [[https://github.com/coreyoconnor/nix_configs][https://github.com/coreyoconnor/nix_configs]]
- [[https://github.com/dejanr/dotfiles][https://github.com/dejanr/dotfiles]]
- [[https://github.com/Ericson2314/nixos-configuration][https://github.com/Ericson2314/nixos-configuration]]
- [[https://gitlab.com/garry-cairns/nixos-config][https://gitlab.com/garry-cairns/nixos-config]]
- [[https://github.com/grahamc/nixos-config][https://github.com/grahamc/nixos-config]]
- [[https://github.com/HugoReeves/nix-home][https://github.com/HugoReeves/nix-home]]
- [[https://github.com/kampfschlaefer/nixconfig][https://github.com/kampfschlaefer/nixconfig]]
- [[https://github.com/lambdael/nixosconf][https://github.com/lambdael/nixosconf]]
- [[https://github.com/puffnfresh/nix-files][https://github.com/puffnfresh/nix-files]]
- [[https://github.com/talyz/nixos-config][https://github.com/talyz/nixos-config]]
- [[https://github.com/uwap/nixos-configs][https://github.com/uwap/nixos-configs]]
- [[https://github.com/yacinehmito/yarn-nix][https://github.com/yacinehmito/yarn-nix]]
- [[https://github.com/yrashk/nix-home][https://github.com/yrashk/nix-home]]
- [[https://github.com/pSub/configs][https://github.com/pSub/configs]]
- [[https://github.com/periklis/nix-config][https://github.com/periklis/nix-config]]
- [[https://github.com/peel/dotfiles][https://github.com/peel/dotfiles]]
- [[https://github.com/bennofs/etc-nixos][https://github.com/bennofs/etc-nixos]]
- [[https://github.com/Baughn/machine-config][https://github.com/Baughn/machine-config]]
- [[https://github.com/gvolpe/nix-config][https://github.com/gvolpe/nix-config]]
- [[https://github.com/myme/dotfiles][https://github.com/myme/dotfiles]]
- [[https://github.com/jedimahdi/.dotfiles][https://github.com/jedimahdi/.dotfiles]]
- [[https://github.com/moni-dz/nix-config][https://github.com/moni-dz/nix-config]]
- [[https://github.com/Aylur/dotfiles][https://github.com/Aylur/dotfiles]]
- [[https://gitlab.com/Zaney/zaneyos][https://gitlab.com/Zaney/zaneyos]]
- [[https://github.com/spikespaz/dotfiles][https://github.com/spikespaz/dotfiles]]
- [[https://github.com/fufexan/dotfiles][https://github.com/fufexan/dotfiles]]
- [[https://github.com/hlissner/dotfiles][https://github.com/hlissner/dotfiles]]
- [[https://github.com/librephoenix/nixos-config][https://github.com/librephoenix/nixos-config]]
- [[https://github.com/AntonHakansson/nixos-config][https://github.com/AntonHakansson/nixos-config]]

* Licensing

Unless otherwise stated in a subdirectory, all code is licensed under the GNU GPL v3. See [[file:COPYING][COPYING]] for details.
