#!/usr/bin/env bash
# get-location - Get current GPS coordinates
# Copyright (C) 2025 Vincent Demeester
# Part of Claude Code Journal skill

set -euo pipefail

# Configuration
CACHE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/journal-location"
CACHE_TIMEOUT=3600  # 1 hour in seconds

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() {
    echo -e "${RED}Error: $*${NC}" >&2
    exit 1
}

debug() {
    if [[ "${DEBUG:-0}" == "1" ]]; then
        echo -e "${YELLOW}Debug: $*${NC}" >&2
    fi
}

usage() {
    cat <<EOF
get-location - Get current GPS coordinates

USAGE:
    get-location [options]

OPTIONS:
    --json              Output as JSON
    --city              Output city name only
    --coords            Output coordinates only (lat,lon)
    --all               Output city and coordinates (default)
    --no-cache          Don't use cached location
    --help, -h          Show this help

OUTPUT FORMATS:
    Default:    Saint-Denis (48.9356,2.3539)
    --json:     {"city":"Saint-Denis","lat":"48.9356","lon":"2.3539"}
    --city:     Saint-Denis
    --coords:   48.9356,2.3539

LOCATION SOURCES:
    1. IP-based geolocation (ipinfo.io) - automatic, approximate
    2. Cache (${CACHE_FILE}) - reuses location for ${CACHE_TIMEOUT}s

EXAMPLES:
    # Get location with city name
    get-location

    # Get just coordinates for journelly-manager
    get-location --coords

    # Get JSON output
    get-location --json

    # Force refresh (ignore cache)
    get-location --no-cache

NOTES:
    - IP-based location is approximate (city-level accuracy)
    - Location is cached for 1 hour to reduce API calls
    - No API key required

VERSION:
    1.0.0

AUTHOR:
    Vincent Demeester <vincent@demeester.fr>
EOF
}

# Check if cache is valid
is_cache_valid() {
    [[ -f "$CACHE_FILE" ]] || return 1

    local cache_age
    cache_age=$(($(date +%s) - $(stat -c %Y "$CACHE_FILE" 2>/dev/null || echo 0)))

    [[ $cache_age -lt $CACHE_TIMEOUT ]]
}

# Get location from cache
get_from_cache() {
    if [[ -f "$CACHE_FILE" ]]; then
        cat "$CACHE_FILE"
        return 0
    fi
    return 1
}

# Get location from IP geolocation
get_from_ip() {
    debug "Fetching location from ipinfo.io"

    local response
    response=$(curl -s --max-time 5 https://ipinfo.io/json 2>/dev/null) || {
        error "Failed to fetch location from ipinfo.io"
    }

    # Validate response
    if ! echo "$response" | jq -e '.loc' >/dev/null 2>&1; then
        error "Invalid response from ipinfo.io"
    fi

    echo "$response"
}

# Parse and format output
format_output() {
    local data="$1"
    local format="${2:-all}"

    local city
    local loc
    local lat
    local lon

    city=$(echo "$data" | jq -r '.city // "Unknown"')
    loc=$(echo "$data" | jq -r '.loc // ""')

    if [[ -z "$loc" ]]; then
        error "No location data available"
    fi

    lat=$(echo "$loc" | cut -d, -f1)
    lon=$(echo "$loc" | cut -d, -f2)

    case "$format" in
        json)
            jq -n \
                --arg city "$city" \
                --arg lat "$lat" \
                --arg lon "$lon" \
                '{city: $city, lat: $lat, lon: $lon}'
            ;;
        city)
            echo "$city"
            ;;
        coords)
            echo "$lat,$lon"
            ;;
        lat)
            echo "$lat"
            ;;
        lon)
            echo "$lon"
            ;;
        all)
            echo "$city ($lat,$lon)"
            ;;
        *)
            error "Unknown format: $format"
            ;;
    esac
}

# Main function
main() {
    local use_cache=true
    local format="all"

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --json)
                format="json"
                ;;
            --city)
                format="city"
                ;;
            --coords)
                format="coords"
                ;;
            --lat)
                format="lat"
                ;;
            --lon)
                format="lon"
                ;;
            --all)
                format="all"
                ;;
            --no-cache)
                use_cache=false
                ;;
            --help|-h)
                usage
                exit 0
                ;;
            *)
                error "Unknown option: $1. Use --help for usage."
                ;;
        esac
        shift
    done

    local data=""

    # Try cache first
    if [[ "$use_cache" == "true" ]] && is_cache_valid; then
        debug "Using cached location"
        data=$(get_from_cache)
    else
        # Fetch from IP geolocation
        data=$(get_from_ip)

        # Cache the result
        mkdir -p "$(dirname "$CACHE_FILE")"
        echo "$data" > "$CACHE_FILE"
        debug "Location cached to $CACHE_FILE"
    fi

    # Format and output
    format_output "$data" "$format"
}

main "$@"
